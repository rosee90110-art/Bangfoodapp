<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตะกร้าสินค้า - BANGFOOD</title>
    <link rel="stylesheet" href="style.css"> 
</head>

<body onload="renderCartItems()">
    <header class="app-header">
    <a href="index.html" class="back-link">
        <i class="fas fa-chevron-left"></i> 
        <span>กลับ</span>
    </a>
    </a>
    <h1 class="bangfood">BANGFOOD</h1>
    <p class="menu-label">หน้า MENU</p>
   </header>

    <div class="cart-container">
        <div class="cart-header-row">
            <button id="track-status-btn" class="status-btn-secondary" onclick="goToTracking()" >
                สถานะอาหาร
            </button>
            <h3 id="table-display-info"></h3> 
        </div>

        <div id="cart-items-list" class="cart-items-list">
        </div>

        <div class="cart-total-summary">
            <h3>ยอดรวมทั้งหมด: <span id="final-total-amount">0.00</span> บาท</h3>
        </div>

        <div id="order-action-area" style="padding-bottom: 20px;">
            <p id="order-confirmed-message" style="display: none; color: #4CAF50; font-weight: bold; font-size: 1.2em; text-align: center; padding: 15px 0;"></p>

            <button id="checkout-btn" class="checkout-btn-large" onclick="placeOrder()"> 
                ยืนยันคำสั่งซื้อ (ชำระเงิน)
            </button>

        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCYIFwwhW7LeM92FqZykqAsDnte09iU9QQ",
            authDomain: "bangfood-cb30f.firebaseapp.com",
            databaseURL: "https://bangfood-cb30f-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "bangfood-cb30f", 
            storageBucket: "bangfood-cb30f.firebasestorage.app",
            messagingSenderId: "390955623784",
            appId: "1:390955623784:web:aed47e64d2e9dd9e7be2dd",
            measurementId: "G-6M6W033GFG"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(); 
    </script>
    
    <script>
        // --- 1. ฟังก์ชันแสดงรายการสินค้า ---
        // --- 1. ฟังก์ชันแสดงรายการสินค้า (ฉบับแก้ไข) ---
function renderCartItems() {
    const listContainer = document.getElementById('cart-items-list');
    const totalAmountDisplay = document.getElementById('final-total-amount');
    const checkoutBtn = document.getElementById('checkout-btn');
    const tableInfoEl = document.getElementById('table-display-info'); // ตัวที่แสดง "โต๊ะที่: T1"
    
    const cartData = sessionStorage.getItem('bangfood_cart');
    const currentCart = cartData ? JSON.parse(cartData) : { items: [], table: null };

    // ✅ ตรวจสอบและแสดง/ล้างเลขโต๊ะ
    if (tableInfoEl) {
        if (currentCart.items && currentCart.items.length > 0 && currentCart.table) {
            tableInfoEl.textContent = "โต๊ะที่: " + currentCart.table;
        } else {
            tableInfoEl.textContent = ""; // ล้างข้อความเลขโต๊ะออกทันที
        }
    }

    // ถ้าตะกร้าว่าง
    if (!currentCart.items || currentCart.items.length === 0) {
        listContainer.innerHTML = '<p class="no-orders-message" style="text-align:center; padding: 20px;">ไม่มีรายการในตะกร้าสินค้า</p>';
        totalAmountDisplay.textContent = '0.00';
        checkoutBtn.style.display = 'none'; 
        return;
    }

    // ถ้ามีสินค้า (ส่วนแสดงผล HTML เดิมของคุณ)
    checkoutBtn.style.display = 'block'; 
    let html = '';
    let total = 0;

    currentCart.items.forEach((item, index) => {
        total += (item.finalPrice || 0);
        html += `
            <div class="cart-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #333; background: var(--bg-color-card); margin-bottom: 8px; border-radius: 8px;">
                <div class="item-details-cart">
                    <p class="item-name-cart" style="font-weight: bold; margin: 0;">${item.name}</p>
                    <small style="color: var(--text-color-secondary);">${item.options || 'ธรรมดา'}</small>
                </div>
                <div style="text-align: right;">
                    <p style="color: var(--price-color); font-weight: bold; margin: 0 0 5px 0;">${(item.finalPrice || 0).toFixed(2)}</p>
                    <button class="remove-btn" onclick="removeItem(${index})" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">ลบ</button>
                </div>
            </div>
        `;
    });

    listContainer.innerHTML = html;
    totalAmountDisplay.textContent = total.toLocaleString(undefined, {minimumFractionDigits: 2});
}

        // --- 2. ฟังก์ชันลบสินค้า ---
        // --- 1. ฟังก์ชันแสดงรายการสินค้า (ฉบับแก้ไข) ---
function renderCartItems() {
    const listContainer = document.getElementById('cart-items-list');
    const totalAmountDisplay = document.getElementById('final-total-amount');
    const checkoutBtn = document.getElementById('checkout-btn');
    const tableInfoEl = document.getElementById('table-display-info'); // ตัวที่แสดง "โต๊ะที่: T1"
    
    const cartData = sessionStorage.getItem('bangfood_cart');
    const currentCart = cartData ? JSON.parse(cartData) : { items: [], table: null };

    // ✅ ตรวจสอบและแสดง/ล้างเลขโต๊ะ
    if (tableInfoEl) {
        if (currentCart.items && currentCart.items.length > 0 && currentCart.table) {
            tableInfoEl.textContent = "โต๊ะที่: " + currentCart.table;
        } else {
            tableInfoEl.textContent = ""; // ล้างข้อความเลขโต๊ะออกทันที
        }
    }

    // ถ้าตะกร้าว่าง
    if (!currentCart.items || currentCart.items.length === 0) {
        listContainer.innerHTML = '<p class="no-orders-message" style="text-align:center; padding: 20px;">ไม่มีรายการในตะกร้าสินค้า</p>';
        totalAmountDisplay.textContent = '0.00';
        checkoutBtn.style.display = 'none'; 
        return;
    }

    // ถ้ามีสินค้า (ส่วนแสดงผล HTML เดิมของคุณ)
    checkoutBtn.style.display = 'block'; 
    let html = '';
    let total = 0;

    currentCart.items.forEach((item, index) => {
        total += (item.finalPrice || 0);
        html += `
            <div class="cart-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #333; background: var(--bg-color-card); margin-bottom: 8px; border-radius: 8px;">
                <div class="item-details-cart">
                    <p class="item-name-cart" style="font-weight: bold; margin: 0;">${item.name}</p>
                    <small style="color: var(--text-color-secondary);">${item.options || 'ธรรมดา'}</small>
                </div>
                <div style="text-align: right;">
                    <p style="color: var(--price-color); font-weight: bold; margin: 0 0 5px 0;">${(item.finalPrice || 0).toFixed(2)}</p>
                    <button class="remove-btn" onclick="removeItem(${index})" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">ลบ</button>
                </div>
            </div>
        `;
    });

    listContainer.innerHTML = html;
    totalAmountDisplay.textContent = total.toLocaleString(undefined, {minimumFractionDigits: 2});
}

// --- 2. ฟังก์ชันลบสินค้า (ฉบับแก้ไข: ล้างเลขโต๊ะเมื่อว่าง) ---
window.removeItem = function(index) {
    const cartData = sessionStorage.getItem('bangfood_cart');
    if (cartData) {
        let currentCart = JSON.parse(cartData);
        
        // ลบรายการออกจาก array
        currentCart.items.splice(index, 1); 

        // ✅ เพิ่มเงื่อนไข: ถ้าลบจนหมดตะกร้า ให้ล้างเลขโต๊ะด้วย
        if (currentCart.items.length === 0) {
            currentCart.table = null; // ล้างสถานะโต๊ะ
            
            // ล้างความจำถาวร (ถ้ามีการใช้ในหน้าอื่น)
            localStorage.removeItem('last_table_number');
        }

        // บันทึกกลับลง Session
        sessionStorage.setItem('bangfood_cart', JSON.stringify(currentCart));
        
        // วาดหน้าจอใหม่ทันที
        renderCartItems(); 
    }
};

        // --- 3. ฟังก์ชันไปหน้า Tracking ---
        window.goToTracking = function() {
            const cartData = sessionStorage.getItem('bangfood_cart');
            const currentCart = cartData ? JSON.parse(cartData) : { table: null };
            const table = currentCart.table || 'N/A';
            window.location.href = `track.html?table=${table}`;
        };

        // --- 4. ฟังก์ชันสั่งซื้อ (โค้ดเดิมของคุณ) ---
        // --- 4. ฟังก์ชันสั่งซื้อ (ฉบับแก้ไข: เคลียร์หน้าจอหลังสั่งซื้อ) ---
window.placeOrder = function() {
    const cartData = sessionStorage.getItem('bangfood_cart');
    const currentCart = cartData ? JSON.parse(cartData) : { items: [], table: null };

    if (!db) { alert("ระบบฐานข้อมูลยังไม่พร้อมใช้งาน"); return; }
    if (currentCart.items.length === 0) {
        alert("ไม่พบรายการในตะกร้าสินค้า!");
        return;
    }
    
    const tableNumber = currentCart.table || 'N/A'; 
    const finalTotal = currentCart.items.reduce((sum, item) => sum + (item.finalPrice || 0), 0); 

    const orderData = {
        tableNumber: tableNumber,
        items: currentCart.items,
        total: finalTotal,
        status: 'รอดำเนินการ', 
        timestamp: firebase.database.ServerValue.TIMESTAMP 
    };

    // ส่งข้อมูลไปยัง Firebase
    db.ref('orders').push(orderData)
        .then(() => {
            // ✅ 1. ล้างข้อมูลตะกร้าใน Session Storage ออกให้หมด
            sessionStorage.removeItem('bangfood_cart');
            
            // ✅ 2. บันทึกเลขโต๊ะลง LocalStorage (เผื่อใช้ดูสถานะภายหลังแม้ปิดหน้าเว็บไป)
            localStorage.setItem('last_table_number', tableNumber);

            alert(`ยืนยันคำสั่งซื้อสำเร็จ! โต๊ะ ${tableNumber}`);

            // ✅ 3. เคลียร์การแสดงผลหน้าตะกร้าทันที (เรียกฟังก์ชันวาดหน้าจอใหม่ซึ่งตอนนี้จะว่างเปล่า)
            renderCartItems(); 

            // ✅ 4. นำทางไปยังหน้าติดตามสถานะ
            window.location.href = `track.html?table=${tableNumber}`;
        })
        .catch(error => {
            console.error("Error:", error);
            alert("เกิดข้อผิดพลาดในการสั่งซื้อ");
        });
};
    </script>
</body>
</html>