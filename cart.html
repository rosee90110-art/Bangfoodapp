<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - BANGFOOD</title>
    <link rel="stylesheet" href="style.css"> 
</head>

<body onload="renderCartItems()">
    <header class="app-header">
        <h1>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
        <p>‡πÄ‡∏°‡∏ô‡∏π ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ</p>
    </header>

    <div class="cart-container">
        <div class="cart-header-row">
            <a href="index.html" class="back-link-in-cart"> MENU </a>
            <h3 id="table-display-info"></h3> 
        </div>

        <div id="cart-items-list" class="cart-items-list">
        </div>

        <div class="cart-total-summary">
            <h3>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="final-total-amount">0.00</span> ‡∏ö‡∏≤‡∏ó</h3>
        </div>

        <div id="order-action-area" style="padding-bottom: 20px;">
            <p id="order-confirmed-message" style="display: none; color: #4CAF50; font-weight: bold; font-size: 1.2em; text-align: center; padding: 15px 0;"></p>

            <button id="checkout-btn" class="checkout-btn-large" onclick="placeOrder()"> 
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô)
            </button>

            <button id="track-status-btn" class="status-btn-secondary" onclick="goToTracking()" style="width: 100%; margin-top: 15px; background: none; border: 2px solid var(--secondary-color); color: var(--secondary-color); padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£ / ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
            </button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCYIFwwhW7LeM92FqZykqAsDnte09iU9QQ",
            authDomain: "bangfood-cb30f.firebaseapp.com",
            databaseURL: "https://bangfood-cb30f-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "bangfood-cb30f", 
            storageBucket: "bangfood-cb30f.firebasestorage.app",
            messagingSenderId: "390955623784",
            appId: "1:390955623784:web:aed47e64d2e9dd9e7be2dd",
            measurementId: "G-6M6W033GFG"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(); 
    </script>
    
    <script>
        // --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ---
        // --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ---
function renderCartItems() {
    const listContainer = document.getElementById('cart-items-list');
    const totalAmountDisplay = document.getElementById('final-total-amount');
    const checkoutBtn = document.getElementById('checkout-btn');
    const tableInfoEl = document.getElementById('table-display-info'); // ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á "‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà: T1"
    
    const cartData = sessionStorage.getItem('bangfood_cart');
    const currentCart = cartData ? JSON.parse(cartData) : { items: [], table: null };

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á/‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞
    if (tableInfoEl) {
        if (currentCart.items && currentCart.items.length > 0 && currentCart.table) {
            tableInfoEl.textContent = "‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà: " + currentCart.table;
        } else {
            tableInfoEl.textContent = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        }
    }

    // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á
    if (!currentCart.items || currentCart.items.length === 0) {
        listContainer.innerHTML = '<p class="no-orders-message" style="text-align:center; padding: 20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>';
        totalAmountDisplay.textContent = '0.00';
        checkoutBtn.style.display = 'none'; 
        return;
    }

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• HTML ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    checkoutBtn.style.display = 'block'; 
    let html = '';
    let total = 0;

    currentCart.items.forEach((item, index) => {
        total += (item.finalPrice || 0);
        html += `
            <div class="cart-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #333; background: var(--bg-color-card); margin-bottom: 8px; border-radius: 8px;">
                <div class="item-details-cart">
                    <p class="item-name-cart" style="font-weight: bold; margin: 0;">${item.name}</p>
                    <small style="color: var(--text-color-secondary);">${item.options || '‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤'}</small>
                </div>
                <div style="text-align: right;">
                    <p style="color: var(--price-color); font-weight: bold; margin: 0 0 5px 0;">${(item.finalPrice || 0).toFixed(2)}</p>
                    <button class="remove-btn" onclick="removeItem(${index})" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">‡∏•‡∏ö</button>
                </div>
            </div>
        `;
    });

    listContainer.innerHTML = html;
    totalAmountDisplay.textContent = total.toLocaleString(undefined, {minimumFractionDigits: 2});
}

        // --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ---
        // --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ---
function renderCartItems() {
    const listContainer = document.getElementById('cart-items-list');
    const totalAmountDisplay = document.getElementById('final-total-amount');
    const checkoutBtn = document.getElementById('checkout-btn');
    const tableInfoEl = document.getElementById('table-display-info'); // ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á "‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà: T1"
    
    const cartData = sessionStorage.getItem('bangfood_cart');
    const currentCart = cartData ? JSON.parse(cartData) : { items: [], table: null };

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á/‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞
    if (tableInfoEl) {
        if (currentCart.items && currentCart.items.length > 0 && currentCart.table) {
            tableInfoEl.textContent = "‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà: " + currentCart.table;
        } else {
            tableInfoEl.textContent = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        }
    }

    // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á
    if (!currentCart.items || currentCart.items.length === 0) {
        listContainer.innerHTML = '<p class="no-orders-message" style="text-align:center; padding: 20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>';
        totalAmountDisplay.textContent = '0.00';
        checkoutBtn.style.display = 'none'; 
        return;
    }

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• HTML ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    checkoutBtn.style.display = 'block'; 
    let html = '';
    let total = 0;

    currentCart.items.forEach((item, index) => {
        total += (item.finalPrice || 0);
        html += `
            <div class="cart-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #333; background: var(--bg-color-card); margin-bottom: 8px; border-radius: 8px;">
                <div class="item-details-cart">
                    <p class="item-name-cart" style="font-weight: bold; margin: 0;">${item.name}</p>
                    <small style="color: var(--text-color-secondary);">${item.options || '‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤'}</small>
                </div>
                <div style="text-align: right;">
                    <p style="color: var(--price-color); font-weight: bold; margin: 0 0 5px 0;">${(item.finalPrice || 0).toFixed(2)}</p>
                    <button class="remove-btn" onclick="removeItem(${index})" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">‡∏•‡∏ö</button>
                </div>
            </div>
        `;
    });

    listContainer.innerHTML = html;
    totalAmountDisplay.textContent = total.toLocaleString(undefined, {minimumFractionDigits: 2});
}

// --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤‡∏á) ---
window.removeItem = function(index) {
    const cartData = sessionStorage.getItem('bangfood_cart');
    if (cartData) {
        let currentCart = JSON.parse(cartData);
        
        // ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å array
        currentCart.items.splice(index, 1); 

        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏à‡∏ô‡∏´‡∏°‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞‡∏î‡πâ‡∏ß‡∏¢
        if (currentCart.items.length === 0) {
            currentCart.table = null; // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ï‡πä‡∏∞
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏ñ‡∏≤‡∏ß‡∏£ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô)
            localStorage.removeItem('last_table_number');
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏á Session
        sessionStorage.setItem('bangfood_cart', JSON.stringify(currentCart));
        
        // ‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        renderCartItems(); 
    }
};

        // --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Tracking ---
        window.goToTracking = function() {
            const cartData = sessionStorage.getItem('bangfood_cart');
            const currentCart = cartData ? JSON.parse(cartData) : { table: null };
            const table = currentCart.table || 'N/A';
            window.location.href = `track.html?table=${table}`;
        };

        // --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ---
        // --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠) ---
window.placeOrder = function() {
    const cartData = sessionStorage.getItem('bangfood_cart');
    const currentCart = cartData ? JSON.parse(cartData) : { items: [], table: null };

    if (!db) { alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"); return; }
    if (currentCart.items.length === 0) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤!");
        return;
    }
    
    const tableNumber = currentCart.table || 'N/A'; 
    const finalTotal = currentCart.items.reduce((sum, item) => sum + (item.finalPrice || 0), 0); 

    const orderData = {
        tableNumber: tableNumber,
        items: currentCart.items,
        total: finalTotal,
        status: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', 
        timestamp: firebase.database.ServerValue.TIMESTAMP 
    };

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Firebase
    db.ref('orders').push(orderData)
        .then(() => {
            // ‚úÖ 1. ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÉ‡∏ô Session Storage ‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î
            sessionStorage.removeItem('bangfood_cart');
            
            // ‚úÖ 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞‡∏•‡∏á LocalStorage (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏°‡πâ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏õ)
            localStorage.setItem('last_table_number', tableNumber);

            alert(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÇ‡∏ï‡πä‡∏∞ ${tableNumber}`);

            // ‚úÖ 3. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ã‡∏∂‡πà‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤)
            renderCartItems(); 

            // ‚úÖ 4. ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            window.location.href = `track.html?table=${tableNumber}`;
        })
        .catch(error => {
            console.error("Error:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
        });
};
    </script>
</body>
</html>