<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ติดตามสถานะคำสั่งซื้อ - BANGFOOD</title>
    <link rel="stylesheet" href="style.css"> 
</head>

<body> 
    
    <header class="app-header">
        <a href="cart.html" class="back-to-menu-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            กลับไปเมนูหลัก
        </a>
        <h1>ติดตามสถานะ</h1>
        <h2 id="tracking-table-header">กำลังโหลดข้อมูล...</h2>
    </header>

    <div class="container">
        
        <div id="status-display" class="status-box">
            <p class="status-text">กำลังเชื่อมต่อข้อมูล...</p>
        </div>

        <div id="order-details-display" class="order-details">
           <div class="block-track">
                <span class="track-item-name-header">รายการสินค้า</span>
                <span class="track-price-header">ราคา</span>
            </div>
            <ul id="items-list-container" class="item-list">
            </ul>
           <div class="total-summary-track">
                <h3 class="total-amount">ยอดรวม: <span id="total-amount-display">0.00 บาท</span></h3>
                
                <button class="pay-btn" onclick="handlePayment()">ชำระเงิน</button>
        </div>

        <div id="no-order-message" style="display: none;">
            <p>ไม่พบคำสั่งซื้อที่กำลังดำเนินการสำหรับโต๊ะนี้</p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCYIFwwhW7LeM92FqZykqAsDnte09iU9QQ",
            authDomain: "bangfood-cb30f.firebaseapp.com",
            databaseURL: "https://bangfood-cb30f-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bangfood-cb30f",
            storageBucket: "bangfood-cb30f.firebasestorage.app",
            messagingSenderId: "390955623784",
            appId: "1:390955623784:web:aed47e64d2e9dd9e7be2dd",
            measurementId: "G-6M6W033GFG"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(); 

    // ฟังก์ชันสำหรับ "ชำระเงิน" (กดจากหน้าติดตามสถานะ)
    window.handlePayment = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const tableNumber = urlParams.get('table') || localStorage.getItem('last_table_number');

        if (!tableNumber) return alert("ไม่พบหมายเลขโต๊ะ");
        if (!confirm(`ยืนยันการชำระเงินสำหรับ โต๊ะ ${tableNumber}?`)) return;

        const ordersRef = db.ref('orders');
        const historyRef = db.ref('history');

        // 1. ค้นหาออเดอร์ของโต๊ะนี้
        ordersRef.orderByChild('tableNumber').equalTo(tableNumber).once('value', (snapshot) => {
            if (snapshot.exists()) {
                let promises = [];

                snapshot.forEach((child) => {
                    const orderData = child.val();
                    
                    // --- แก้ไขจุดนี้: ใช้ .update แทน .remove ---
                    // เพื่อให้ข้อมูลในหน้า Admin (Node orders) ไม่หายไป
                    const updateTask = child.ref.update({
                        status: 'ชำระเงินแล้ว'
                    });
                    promises.push(updateTask);

                    // --- ส่งสำเนาไปที่หน้า History เพื่อรวมยอดเงิน ---
                    const historyData = {
                        ...orderData,
                        status: 'ชำระเงินแล้ว',
                        paymentTimestamp: firebase.database.ServerValue.TIMESTAMP 
                    };
                    promises.push(historyRef.push(historyData));
                });

                Promise.all(promises).then(() => {
                    alert("✅ ชำระเงินเรียบร้อย! รายการในหน้าแอดมินเปลี่ยนเป็น 'ชำระเงินแล้ว'");
                    window.location.href = 'history.html'; // ไปหน้าประวัติ
                }).catch(err => {
                    console.error(err);
                    alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
                });
            } else {
                alert("ไม่พบรายการที่ต้องชำระเงิน");
            }
        });
    };

    // ฟังก์ชันดึงสถานะมาโชว์ที่หน้า Track (เพื่อให้ลูกค้าเห็นว่าจ่ายแล้ว)
    function startTracking() {
        const urlParams = new URLSearchParams(window.location.search);
        const tableNumber = urlParams.get('table') || localStorage.getItem('last_table_number');
        
        if (tableNumber) {
            document.getElementById('tracking-table-header').textContent = "โต๊ะ " + tableNumber;
            
            db.ref('orders').orderByChild('tableNumber').equalTo(tableNumber).on('value', (snapshot) => {
                const listContainer = document.getElementById('items-list-container');
                const totalDisplay = document.getElementById('total-amount-display');
                const statusText = document.querySelector('.status-text');
                
                if (snapshot.exists()) {
                    let html = '';
                    let total = 0;
                    let lastStatus = '';

                    snapshot.forEach(child => {
                        const order = child.val();
                        lastStatus = order.status;
                        total += parseFloat(order.total || 0);
                        order.items.forEach(item => {
                            html += `<li class="track-item" style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #333;">
                                <span>${item.name} x${item.quantity || 1}</span>
                                <span>${parseFloat(item.finalPrice).toFixed(2)} ฿</span>
                            </li>`;
                        });
                    });
                    listContainer.innerHTML = html;
                    totalDisplay.textContent = total.toFixed(2) + " บาท";
                    statusText.textContent = "สถานะ: " + lastStatus;
                }
            });
        }
    }
    document.addEventListener('DOMContentLoaded', startTracking);
</script>
    
   <script src="script.js"></script>
<body onload="startTrackingSystem()">
</body>
</html>